"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],a=!0,r=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(a=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);a=!0);}catch(t){r=!0,i=t}finally{try{a||null==s.return||s.return()}finally{if(r)throw i}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warning(t,e){if(t="\n\n[MpStore warning]: ".concat(t,"\n\n"),!e)throw new Error(t);console.warn(t)}function assert(t,e){t||warning(e)}function isPrimitive(t){return"string"==typeof t||"number"==typeof t||"symbol"===_typeof(t)||"boolean"==typeof t}function deepFreeze(t){for(var e=Object.getOwnPropertyNames(t),n=e.length;~n--;){var a=t[e[n]];"object"===_typeof(a)&&null!==a&&deepFreeze(a)}return Object.freeze(t)}function mergeState(t,e){return deepFreeze(Object.assign({},t,e))}function mixinMethods(t,e){for(var n in e)n in t||(t[n]=e[n])}function inspectStateNamespace(t,e,n){for(var a in t)assert(!e.hasOwnProperty(a),n(a))}function remove(t,e){var n=t.findIndex((function(t){return t.component===e}));n>-1&&t.splice(n,1)}function callHook(t,e,n){if(t&&"function"==typeof t[e])return t[e].apply(t,n)}function isEmptyObject(t){for(var e in t)return!1;return!0}function mapObject(t,e){var n={};for(var a in t)t.hasOwnProperty(a)&&(n[a]=e(t[a]));return n}function createWraper(t,e,n){return function(){for(var a,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return"function"==typeof e&&e.apply(this,i),"function"==typeof t&&(a=t.apply(this,i)),"function"==typeof n&&n.apply(this,i),a}}function isPlainObject(t){if("object"!==_typeof(t)||null===t)return!1;var e=Object.getPrototypeOf(t);if(null===e)return!0;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n}function clone(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(null==t||isPrimitive(t)||"function"==typeof t||t instanceof Date)return t;if(e.has(t))return e.get(t);var n="function"!=typeof t.constructor?Object.create(null):new t.constructor;for(var a in e.set(t,n),t)n[a]=clone(t[a],e);return n}function mixin(t){var e=Object.create(null);if("function"==typeof t){t((function(t,n){assert("string"==typeof t,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(t in e),'The "'.concat(t,'" is exist,')),e[t]=n}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n,a){this.type=t,this.path=e,this.value=n,this.leftValue=a}function diffValues(t,e,n,a){"function"==typeof t||null===t?a.push(new Patch(REPLACE,n,e,t)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,a):a.push(new Patch(REPLACE,n,e,t)):"object"===_typeof(t)?null===e||"object"!==_typeof(e)||Array.isArray(e)?a.push(new Patch(REPLACE,n,e,t)):t instanceof Date||e instanceof Date?a.push(new Patch(REPLACE,n,e,t)):walkObject(t,e,n,a):a.push(new Patch(REPLACE,n,e,t))}function walkArray(t,e,n,a){if(t.length<=e.length){for(var r=t.length;~--r;)if(t[r]!==e[r]){var i="".concat(n,"[").concat(r,"]");diffValues(t[r],e[r],i,a)}if(e.length>t.length)for(r=e.length;--r>=t.length;){var o="".concat(n,"[").concat(r,"]");a.push(new Patch(ADD,o,e[r],t[r]))}}else a.push(new Patch(REPLACE,n,e,t))}function walkObject(t,e,n,a){for(var r in t){var i="".concat(n,".").concat(r);r in e?t[r]!==e[r]&&diffValues(t[r],e[r],i,a):a.push(new Patch(REMOVE,i,null,t[r]))}for(var o in e)if(!(o in t)){var s="".concat(n,".").concat(o);a.push(new Patch(ADD,s,e[o],null))}}function diff(t,e,n){var a=[];return walkObject(t,e,n,a),a}var REG=/[^\[\].]+(?=[\[\].])/g;function separatePath(t,e){var n=e.match(REG);if(n&&n.shift()&&n.length>0){for(var a=-1,r=null,i=t,o=null;a++<n.length-2;)o=i,i=i[r=n[a]];return[i,r,o,n[n.length-1]]}}function restore(t,e){for(var n=e.length,a=new Map;~--n;){var r=e[n],i=r.type,o=r.path,s=r.leftValue,c=separatePath(t,o+".");if(c){var l=_slicedToArray(c,4),u=l[0],f=l[1],h=l[2],p=l[3];switch(i){case REMOVE:case REPLACE:u[p]=s;break;case ADD:Array.isArray(u)&&u===h[f]&&a.set(u,{key:f,prevTarget:h}),delete u[p]}}}return a.forEach((function(t,e){var n=t.key,a=t.prevTarget,r=new e.constructor;e.forEach((function(t){return r.push(t)})),a[n]=r})),t}function applyPatchs(t,e,n){for(var a={},r=0,i=e.length;r<i;r++){var o=e[r],s=o.value;a[o.path]=s}t.setData(a,n)}function updateComponents(t,e){var n=0,a=t.hooks,r=t.GLOBALWORD,i=t.depComponents,o=i.length;if(0!==o)for(var s=function(){++n===o&&"function"==typeof e&&e()},c=0;c<o;c++){var l=i[c],u=l.isPage,f=l.component,h=l.didUpdate,p=l.willUpdate,d=l.createState;if(f.data[r]){var y=d();if("function"==typeof p&&!1===p.call(t,f,y)){s();continue}var v=diff(f.data[r],y,r);if(v.length>0){if(!1===callHook(a,"willUpdate",[f,y,v,u])){s();continue}applyPatchs(f,v,s),"function"==typeof h&&h.call(t,f,y,v),callHook(a,"didUpdate",[f,y,u]),f.timeTravel&&f.timeTravel.push(v)}else s()}else s()}else"function"==typeof e&&e()}var TimeTravel=function(){function t(e,n,a){_classCallCheck(this,t),this.history=[],this.limit=a,this.component=e,this.GLOBALWORD=n,this.length=this.history.length,this.current=this.history.length,this.finallyState=e.data[n]}return _createClass(t,[{key:"push",value:function(t){var e=this.limit,n=this.history,a=this.GLOBALWORD,r=this.history.length,i=this.component.data;if(e>0){var o=r-e;o>=0&&this.history.splice(0,o+1),this.history.push(t),this.length=n.length,this.current=n.length,this.finallyState=clone(i[a])}}},{key:"go",value:function(t){var e=this.current,n=this.history,a=this.component,r=this.GLOBALWORD,i=this.finallyState;if(assert(r in a.data,"You can't use [timeTravel] because it only works for [global state]"),this.limit>0&&0!==t){var o=t+e,s=Math.abs(t);if(o<0||o>n.length)return void warning("Index [".concat(o,"] is not within the allowed range."),!0);for(var c=0,l=clone(a.data[r]);c++<s;){var u=e+Math.sign(t)*c;if(u<n.length)l=restore(l,clone(n[u]));else l=i}var f=diff(a.data[r],l,r);f.length>0&&applyPatchs(a,f),this.current+=t}}},{key:"forward",value:function(){this.go(1)}},{key:"back",value:function(){this.go(-1)}},{key:"toStart",value:function(){this.go(-this.current)}},{key:"toEnd",value:function(){this.go(this.history.length-this.current)}}]),t}(),COMMONACTION=function(){};function match(t,e){return t.action===COMMONACTION||e===t.action}function handleLayer(t,e,n,a,r,i){try{e.call(n,a,r,t),i()}catch(e){var o=n.hooks;i(),o&&"function"==typeof o.middlewareError?o.middlewareError(t,a,e):warning("".concat(e,"\n\n   --- from middleware [").concat(t,"] action."))}}var Middleware=function(){function t(e){_classCallCheck(this,t),this.stack=[],this.store=e,this.isProcessing=!1}return _createClass(t,[{key:"use",value:function(t,e){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:e,action:t})}},{key:"remove",value:function(t,e){var n=this.stack.findIndex((function(n){return n.fn===e&&n.action===t}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(t,e,n){var a=this;this.isProcessing=!0;var r=function(){a.isProcessing=!1};if(this.stack.length>0){var i=0;!function e(o){var s=a.stack[i];for(i++;s&&!match(s,t);)s=a.stack[i++];s?handleLayer(t,s.fn,a.store,o,e,r):n(o,r)}(e)}else n(e,r)}}]),t}(),storeId=0;function filterReducer(t,e,n){var a=n.setter,r=n.namespace,i=n.partialState;if(assert("partialState"in n,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(i),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),"namespace"in n){assert("string"==typeof r,"The module namespace must be a string."+"\n\n --- from [".concat(e,"] action."));var o=t[r];r in t&&(isPlainObject(o)&&o.__mpModule||warning("The module [".concat(r,"] in the global state, you can't defined [").concat(r,"] module")+"\n\n --- from [".concat(e,"] action."))),o?(inspectStateNamespace(i,o,(function(t){return"The [".concat(t,"] already exists in [").concat(r,"] module, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action.")})),n.partialState=_defineProperty({},r,Object.assign({},o,i))):n.partialState=_defineProperty({},r,Object.assign(i,_defineProperty({},"__mpModule",!0)))}else inspectStateNamespace(i,t,(function(t){return"The [".concat(t,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action.")}));return"function"!=typeof a&&(n.setter=function(){warning("Can't changed [".concat(e,"] action value. Have you defined a setter?")+"\n\n --- from [".concat(e,"] action."))}),n}var Store=function(){function t(e){_classCallCheck(this,t),this.hooks=e,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.10",this.state=Object.freeze({}),this.middleware=new Middleware(this)}return _createClass(t,[{key:"add",value:function(t,e){assert(!this.reducers.find((function(e){return e.action===t})),"Can't repeat defined [".concat(t,"] action."));var n=filterReducer(this.state,t,e).partialState;e.action=t,this.reducers.push(e),isEmptyObject(n)||(this.state=mergeState(this.state,n))}},{key:"dispatch",value:function(t,e,n){var a=this,r=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(t,"] action."));var i=r.find((function(e){return e.action===t}));assert(i,"The [".concat(t,"] action does not exist. ")+"Maybe you have not defined."),this.middleware.process(t,e,(function(t,e){a.isDispatching=!0;try{var r,o=i.namespace,s="string"==typeof o;if(s){var c=a.getModule(o,!0);r=i.setter(c,t,a.state)}else r=i.setter(a.state,t);assert(isPlainObject(r),"setter function should be return a plain object."),isEmptyObject(r)||(a.state=mergeState(a.state,s?_defineProperty({},o,Object.assign({},a.getModule(o),r)):r))}finally{a.isDispatching=!1,e()}updateComponents(a,n)}))}},{key:"use",value:function(t,e){var n=this;return"function"==typeof t&&t!==COMMONACTION&&(e=t,t=COMMONACTION),this.middleware.use(t,e),function(){return n.middleware.remove(t,e)}}},{key:"setNamespace",value:function(t){assert(t&&"string"==typeof t,"The [namespace] must be a string"),this.GLOBALWORD=t}},{key:"getModule",value:function(t,e){var n=this.state[t];return!e||isPlainObject(n)&&n.__mpModule||warning("The [".concat(t,"] module is not exist.")),n}},{key:"rewirteCfgAndAddDep",value:function(t,e){var n=this,a=null,r=this,i=this.GLOBALWORD,o=t.data,s=t.storeConfig,c=void 0===s?{}:s,l=c.useState,u=c.didUpdate,f=c.willUpdate,h=c.defineReducer,p=c.travelLimit,d=void 0===p?0:p;if(assert("number"==typeof d,"[travelLimit] must be a number, but now is [".concat(_typeof(d),"].")),delete t.storeConfig,"function"==typeof h&&h.call(r,r),"function"==typeof l){var y=null,v=null,m=l.call(r,r);Array.isArray(m)?(y=m[0],v=m[1]):v=m,assert(isPlainObject(v),"[useState] must return a plain object, "+"but now is return a [".concat(_typeof(v),"]")),a=function(){return clone(mapObject(v,(function(t){return null===y?t(r.state):t(n.getModule(y,!0),r.state)})))}}if(null!==a){var g=a();isPlainObject(g)&&(o?o[i]=g:t.data=_defineProperty({},i,g))}var b=function(t){if(!1!==callHook(n.hooks,"addDep",[t,e])&&null!==a&&t.data&&isPlainObject(t.data[i])){t.timeTravel=new TimeTravel(t,i,d),n.depComponents.push({isPage:e,component:t,didUpdate:u,willUpdate:f,createState:a});var r=diff(t.data[i],a(),i);r.length>0&&applyPatchs(t,r,i)}};if(e)t.onLoad=createWraper(t.onLoad,(function(){b(this),this.store=r})),t.onUnload=createWraper(t.onUnload,null,(function(){remove(r.depComponents,this)}));else{t.lifetimes=t.lifetimes||{};var w=function(e){return t[e]||t.lifetimes[e]},O=function(e,n){return t[e]=t.lifetimes[e]=n};O("attached",createWraper(w("attached"),(function(){b(this),this.store=r}))),O("detached",createWraper(w("detached"),null,(function(){remove(r.depComponents,this)})))}}}]),t}(),version="0.0.10",nativePage=Page,nativeComponent=Component;function expandConfig(t,e,n){isEmptyObject(e)||(n?mixinMethods(t,e):(t.methods=t.methods||{},mixinMethods(t.methods,e)))}function index(t,e){var n=new Store(e),a=mixin(t);return Page=createWraper(nativePage,(function(t){callHook(e,"createBefore",[t,!0]),expandConfig(t,a,!0),n.rewirteCfgAndAddDep(t,!0)})),Component=createWraper(nativeComponent,(function(t){callHook(e,"createBefore",[t,!1]),expandConfig(t,a,!1),n.rewirteCfgAndAddDep(t,!1)})),n}exports.clone=clone,exports.default=index,exports.diff=diff,exports.restore=restore,exports.version=version;
