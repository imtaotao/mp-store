/*!
 * Mpstore.js v0.2.4
 * (c) 2019-2020 Imtaotao
 * Released under the MIT License.
 */
"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],a=!0,o=!1,r=void 0;try{for(var i,s=e[Symbol.iterator]();!(a=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(e){o=!0,r=e}finally{try{a||null==s.return||s.return()}finally{if(o)throw r}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warning(e,t){if(e="\n\nMpStore warning: ".concat(e,"\n\n"),!t)throw new Error(e);console.warn(e)}function assert(e,t){e||warning(t)}function isPrimitive(e){return"string"==typeof e||"number"==typeof e||"symbol"===_typeof(e)||"boolean"==typeof e}function deepFreeze(e){if(Object.isFrozen(e))return e;for(var t=Object.getOwnPropertyNames(e),n=t.length;~n--;){var a=e[t[n]];"object"===_typeof(a)&&null!==a&&deepFreeze(a)}return Object.freeze(e)}function mergeState(e,t,n){var a=Object.assign({},e,t);return"develop"===n?deepFreeze(a):a}function mixinMethods(e,t){for(var n in t)n in e||(e[n]=t[n])}function remove(e,t){var n=e.findIndex((function(e){return e.component===t}));n>-1&&e.splice(n,1)}function callHook(e,t,n){if(e&&"function"==typeof e[t])return e[t].apply(e,n)}function isEmptyObject(e){for(var t in e)return!1;return!0}function mapObject(e,t){var n={};for(var a in e)e.hasOwnProperty(a)&&(n[a]=t(e[a]));return n}function createWraper(e,t,n){return function(){for(var a,o=arguments.length,r=new Array(o),i=0;i<o;i++)r[i]=arguments[i];return"function"==typeof t&&t.apply(this,r),"function"==typeof e&&(a=e.apply(this,r)),"function"==typeof n&&n.apply(this,r),a}}function isPlainObject(e){if("object"!==_typeof(e)||null===e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;for(var n=t;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return t===n}function clone(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(null==e||isPrimitive(e)||"function"==typeof e||e instanceof Date)return e;if(t.has(e))return t.get(e);var n="function"!=typeof e.constructor?Object.create(null):new e.constructor;for(var a in t.set(e,n),e)n[a]=clone(e[a],t);return n}function mixin(e){var t=Object.create(null);if("function"==typeof e){e((function(e,n){assert("string"==typeof e,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(e in t),'The "'.concat(e,'" is exist,')),t[e]=n}))}return t}Object.defineProperty(exports,"__esModule",{value:!0});var MODULE_FLAG=Symbol("module");function isModule(e){return isPlainObject(e)&&!0===e[MODULE_FLAG]}function addModuleFlag(e){return e[MODULE_FLAG]=!0,e}function createModule(e){return assert(isPlainObject(e),"The base module object must be an plain object"),isModule(e)?e:(addModuleFlag(e),e)}function getModule(e,t){if(!t)return e;for(var n=e,a=t.split("."),o=0,r=a.length;o<r;o++){if(!isModule(n))return null;n=n[a[o]]}return isModule(n)?n:null}function assertChildModule(e,t,n){var a=isModule(e),o=isModule(t);return assert(!(a&&!o),"The namespace [".concat(n,"] is a module that you can change to other value, ")+"You can use `createModule` method to recreate a module.\n\n  --- from setter function."),assert(!(!a&&o),"The namespace [".concat(n,"] is not a module, you can't create it as a module, ")+"you must define the module in `reducer`.\n\n  --- from setter function."),a&&o}function checkChildModule(e,t){for(var n=Object.keys(t),a=n.length;~--a;){var o=n[a];assertChildModule(e[o],t[o],o)&&checkChildModule(e[o],t[o])}for(a=(n=Object.keys(e)).length;~--a;){var r=n[a];r in t||assertChildModule(e[r],t[r],r)}}function mergeModule(e,t,n,a,o){if("develop"===o)for(var r=Object.keys(t),i=r.length;~--i;){var s=r[i];if("function"==typeof a)assert(!(s in e),a(s,n));else{var c=e[s],l=t[s];assertChildModule(c,l,s)&&checkChildModule(c,l)}}return createModule(Object.assign({},e,t))}function createModuleByNamespace(e,t,n,a,o,r){if(t=t||{},!e)return mergeModule(n,t,null,null,r);for(var i={},s=n,c=i,l=e.split("."),u="\n\n  --- from [".concat(a,"] action"),f=0,d=l.length;f<d;f++){var h=void 0,p=l[f],v=f===d-1;p in s?("develop"===r&&assert(isModule(s[p]),"you can't create child moudle, "+"because namespace [".concat(p,"] already exists in [").concat(l[f-1]||"root","] module, ")+"but [".concat(p,"] not a module.").concat(u)),h=v?mergeModule(s[p],t,p,o,r):Object.assign({},s[p])):h=v?createModule(t):addModuleFlag({}),i[p]=h,i=h,s=h}return c}var ADD=1,REMOVE=2,REPLACE=3;function Patch(e,t,n,a){this.type=e,this.path=t,this.value=n,this.leftValue=a}function diffValues(e,t,n,a){"function"==typeof e||null===e?a.push(new Patch(REPLACE,n,t,e)):Array.isArray(e)?Array.isArray(t)?walkArray(e,t,n,a):a.push(new Patch(REPLACE,n,t,e)):"object"===_typeof(e)?null===t||"object"!==_typeof(t)||Array.isArray(t)?a.push(new Patch(REPLACE,n,t,e)):e instanceof Date||t instanceof Date?a.push(new Patch(REPLACE,n,t,e)):walkObject(e,t,n,a):a.push(new Patch(REPLACE,n,t,e))}function walkArray(e,t,n,a){if(e.length<=t.length){for(var o=e.length;~--o;)if(e[o]!==t[o]){var r="".concat(n,"[").concat(o,"]");diffValues(e[o],t[o],r,a)}if(t.length>e.length)for(o=t.length;--o>=e.length;){var i="".concat(n,"[").concat(o,"]");a.push(new Patch(ADD,i,t[o],e[o]))}}else a.push(new Patch(REPLACE,n,t,e))}function walkObject(e,t,n,a){for(var o in e){var r="".concat(n,".").concat(o);o in t?e[o]!==t[o]&&diffValues(e[o],t[o],r,a):a.push(new Patch(REMOVE,r,null,e[o]))}for(var i in t)if(!(i in e)){var s="".concat(n,".").concat(i);a.push(new Patch(ADD,s,t[i],null))}}function diff(e,t,n){var a=[];return walkObject(e,t,n,a),a}var REG=/[^\[\].]+(?=[\[\].])/g;function separatePath(e,t){var n=t.match(REG);if(n&&n.shift()&&n.length>0){for(var a=-1,o=null,r=e,i=null;a++<n.length-2;)i=r,r=r[o=n[a]];return[r,o,i,n[n.length-1]]}}function restore(e,t){for(var n=t.length,a=new Map;~--n;){var o=t[n],r=o.type,i=o.path,s=o.leftValue,c=separatePath(e,i+".");if(c){var l=_slicedToArray(c,4),u=l[0],f=l[1],d=l[2],h=l[3];switch(r){case REMOVE:case REPLACE:u[h]=s;break;case ADD:Array.isArray(u)&&u===d[f]&&a.set(u,{key:f,prevTarget:d}),delete u[h]}}}return a.forEach((function(e,t){var n=e.key,a=e.prevTarget,o=new t.constructor;t.forEach((function(e){return o.push(e)})),a[n]=o})),e}function applyPatchs(e,t,n){for(var a={},o=0,r=t.length;o<r;o++){var i=t[o],s=i.value;a[i.path]=s}e.setData(a,n)}function asyncUpdate(e,t,n){null!==t?(0===e[t].length&&setTimeout((function(){var n=e[t].slice();e[t].length=0,updateComponents(e,(function(){for(var e=0;e<n.length;e++)"function"==typeof n[e]&&n[e]()}))})),e[t].push(n)):updateComponents(e,n)}function updateComponents(e,t){var n=0,a=e.hooks,o=e.GLOBALWORD,r=e.depComponents;if(0!==r.length)for(var i=r.slice(),s=i.length,c=function(){++n===s&&(t._called||(t._called=!0,t()))},l=0;l<s;l++){var u=i[l],f=u.isPage,d=u.component,h=u.didUpdate,p=u.willUpdate,v=u.createState;if(d._$loaded&&d.data[o]){var y=v();if("function"==typeof p&&!1===p.call(e,d,y)){c();continue}var m=diff(d.data[o],y,o);if(m.length>0){if(!1===callHook(a,"willUpdate",[d,y,m,f])){c();continue}applyPatchs(d,m,c),"function"==typeof h&&h.call(e,d,y,m),callHook(a,"didUpdate",[d,y,f]),d.timeTravel&&d.timeTravel.push(m)}else c()}else c()}else t()}var TimeTravel=function(){function e(t,n,a,o){_classCallCheck(this,e),this.env=o,this.history=[],this.limit=a,this.component=t,this.GLOBALWORD=n,this.length=this.history.length,this.current=this.history.length,this.finallyState=t.data[n]}return _createClass(e,[{key:"push",value:function(e){var t=this.limit,n=this.history,a=this.GLOBALWORD,o=this.history.length,r=this.component.data;if(t>0){var i=o-t;i>=0&&this.history.splice(0,i+1),this.history.push(e),this.length=n.length,this.current=n.length,this.finallyState=clone(r[a])}}},{key:"go",value:function(e){var t=this.env,n=this.current,a=this.history,o=this.component,r=this.GLOBALWORD,i=this.finallyState;if("develop"===t&&assert(r in o.data,"You can't use [timeTravel] because it only works for [global state]"),this.limit>0&&0!==e){var s=e+n,c=Math.abs(e);if(s<0||s>a.length)return void("develop"===t&&warning("Index [".concat(s,"] is not within the allowed range."),!0));for(var l=0,u=clone(o.data[r]);l++<c;){var f=n+Math.sign(e)*l;if(f<a.length)u=restore(u,clone(a[f]));else u=i}var d=diff(o.data[r],u,r);d.length>0&&applyPatchs(o,d),this.current+=e}}},{key:"forward",value:function(){this.go(1)}},{key:"back",value:function(){this.go(-1)}},{key:"toStart",value:function(){this.go(-this.current)}},{key:"toEnd",value:function(){this.go(this.history.length-this.current)}}]),e}(),defaultOption={env:"develop",storeNamespace:"store",globalNamespace:"global"},COMMONACTION=function(){};function match(e,t){return e.action===COMMONACTION||(Array.isArray(e.action)?e.action.indexOf(t)>-1:t===e.action)}function handleLayer(e,t,n,a,o,r){try{t.call(n,a,o,e),r()}catch(t){var i=n.hooks;r(),i&&"function"==typeof i.middlewareError?i.middlewareError(e,a,t):"develop"===n.options.env&&warning("".concat(t,"\n\n   --- from middleware [").concat(e.toString(),"] action."))}}var Middleware=function(){function e(t){_classCallCheck(this,e),this.stack=[],this.store=t,this.isProcessing=!1}return _createClass(e,[{key:"use",value:function(e,t){"develop"===this.store.options.env&&assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:t,action:e})}},{key:"remove",value:function(e,t){var n=this.stack.findIndex((function(n){return n.fn===t&&n.action===e}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(e,t,n){var a=this;this.isProcessing=!0;var o=function(){a.isProcessing=!1};if(this.stack.length>0){var r=0;!function t(i){var s=a.stack[r];for(r++;s&&!match(s,e);)s=a.stack[r++];s?handleLayer(e,s.fn,a.store,i,t,o):n(i,o)}(t)}else n(t,o)}}]),e}(),storeId=0;function assertReducer(e,t){var n=t.setter,a=t.partialState,o=e.toString();return assert(!("partialState"in t&&!isPlainObject(a)),"The [partialState] must be an object."+"\n\n --- from [".concat(o,"] action.")),"function"!=typeof n&&(t.setter=function(){warning("Can't changed [".concat(o,"] action value. Have you defined a setter?")+"\n\n --- from [".concat(o,"] action."))}),t}function filterReducer(e,t,n,a){var o=t.toString(),r=n.namespace,i=n.partialState;if("namespace"in n)assert("string"==typeof r,"The module namespace must be a string."+"\n\n --- from [".concat(o,"] action.")),n.partialState=createModuleByNamespace(r,i,e,o,(function(e,t){return"The [".concat(e,"] already exists in [").concat(t,"] module, ")+"Please don't repeat defined. \n\n --- from [".concat(o,"] action.")}),a);else if("develop"===a)for(var s in i)assert(!e.hasOwnProperty(s),"The [".concat(s,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(o,"] action."));return n}var Store=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e),this.hooks=t,this.reducers=[],this.id=++storeId,this.depComponents=[],this.isDispatching=!1,this.restoreCallbacks=[],this.dispatchCallbacks=[],this.version="0.2.4",this.state=Object.freeze(createModule({})),this.middleware=new Middleware(this),this.options=Object.assign({},defaultOption,n),this.GLOBALWORD=this.options.globalNamespace}return _createClass(e,[{key:"add",value:function(e,t){var n=this.options.env;if("develop"===n){var a=_typeof(e);assert("string"===a||"symbol"===a,"The action must be a Symbol or String, but now is [".concat(a,"].")),assert(!this.reducers.find((function(t){return t.action===e})),"Can't repeat defined [".concat(e.toString(),"] action."))}var o=t.partialState;"develop"===n&&assertReducer(e,t),filterReducer(this.state,e,t,n),t.action=e,this.reducers.push(t);var r=t.partialState;r&&!isEmptyObject(r)&&(this.state=mergeState(this.state,r,n)),t.partialState=o}},{key:"dispatch",value:function(e,t,n){var a=this,o=this.reducers,r=this.isDispatching,i=this.options.env,s=e.toString();"develop"===i&&assert(!r,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(s,"] action.")),this.middleware.process(e,t,(function(t,r){a.isDispatching=!0;try{var c,l=o.find((function(t){return t.action===e}));"develop"===i&&assert(l,"The [".concat(s,"] action does not exist. ")+"Maybe you have not defined.");var u=l.namespace,f="string"==typeof u;if(f){var d=a.getModule(u,"\n\n --- from [".concat(s,"] action."));c=l.setter(d,t,a.state)}else c=l.setter(a.state,t);if("develop"===i&&assert(isPlainObject(c),"setter function should be return a plain object."),!isEmptyObject(c))if(f)c=createModuleByNamespace(u,c,a.state,s,null,i),a.state=mergeState(a.state,c,i);else{var h=mergeModule(a.state,c,null,null,i);a.state="develop"===i?h:deepFreeze(h)}}finally{a.isDispatching=!1,r()}asyncUpdate(a,"dispatchCallbacks",(function(){"function"==typeof n&&n(t)}))}))}},{key:"restore",value:function(e,t,n){var a=this.options.env,o=this.reducers.find((function(t){return t.action===e})),r=e.toString();"develop"===a&&assert(o,"The [".concat(r,"] action does not exist. ")+"Maybe you have not defined.");var i=o.namespace,s=o.partialState;if("develop"===a&&assert(isPlainObject(s),"no initialized state, do you have a definition?"+"\n\n   --- from [".concat(r,"] action.")),"string"==typeof i){var c=createModuleByNamespace(i,s,this.state,r,a);this.state=mergeState(this.state,c,a)}else{var l=mergeModule(this.state,s,null,null,a);this.state="develop"===a?l:deepFreeze(l)}n?t(s):asyncUpdate(this,"restoreCallbacks",(function(){"function"==typeof t&&t(s)}))}},{key:"forceUpdate",value:function(){asyncUpdate(this,null,COMMONACTION)}},{key:"use",value:function(e,t){var n=this;return"function"==typeof e&&e!==COMMONACTION&&(t=e,e=COMMONACTION),this.middleware.use(e,t),function(){return n.middleware.remove(e,t)}}},{key:"setNamespace",value:function(e){"develop"===this.options.env&&(assert(e&&"string"==typeof e,"The [namespace] must be a string"),console.error("The `setNamespace` is deprecated, please use options to specify.")),this.options.globalNamespace=this.GLOBALWORD=e}},{key:"getModule",value:function(e,t){var n=this.options.env;if("develop"===n&&assert("string"==typeof e,"the namespace mast be a string"),!e)return this.state;var a=getModule(this.state,e);return t&&null===a&&"develop"===n&&warning("The [".concat(e,"] module is not exist.").concat(t||"")),a}},{key:"addModule",value:function(e,t){var n=this;if("develop"===this.options.env&&assert("string"==typeof e,"the namespace mast be a string"),isPlainObject(t)){var a=Object.keys(t),o=Object.getOwnPropertySymbols(t);if(a.length+o.length>0){for(var r=0,i=function(a){var o=t[a];o.namespace=e,n.add(a,o)};r<a.length;r++)i(a[r]);for(r=0;r<o.length;r++)i(o[r])}}}},{key:"rewirteConfigAndAddDep",value:function(e,t){var n=this,a=null,o=this,r=this.GLOBALWORD,i=e.data,s=e.storeConfig,c=void 0===s?{}:s,l=this.options,u=l.env,f=l.storeNamespace,d=c.addDep,h=c.useState,p=c.didUpdate,v=c.willUpdate,y=c.defineReducer,m=c.travelLimit,g=void 0===m?0:m;if("develop"===u&&assert("number"==typeof g,"[travelLimit] must be a number, but now is [".concat(_typeof(g),"].")),delete e.storeConfig,"function"==typeof y&&y.call(o,o),"function"==typeof h){var b=null,O=null,w=h.call(o,o);Array.isArray(w)?(b=w[0],O=w[1]):O=w,"develop"===u&&assert(isPlainObject(O),"[useState] must return a plain object, "+"but now is return a [".concat(_typeof(O),"]")),a=null===b?function(){return clone(mapObject(O,(function(e){return e(o.state)})))}:function(){var e=n.getModule(b,"\n\n   --- from [".concat(b,"] of useState."));return clone(mapObject(O,(function(t){return t(e,o.state)})))}}if(null!==a){var M=a();isPlainObject(M)&&(i?i[r]=M:e.data=_defineProperty({},r,M))}var C=function(e){if(("function"!=typeof d||!1!==d.call(o,e,t))&&(!1!==callHook(n.hooks,"addDep",[e,t])&&null!==a&&e.data&&isPlainObject(e.data[r]))){e.timeTravel=new TimeTravel(e,r,g,u),n.depComponents.push({isPage:t,component:e,didUpdate:p,willUpdate:v,createState:a});var i=diff(e.data[r],a(),r);i.length>0&&applyPatchs(e,i,r)}};function P(){C(this),this[f]=o,this._$loaded=!0}function k(){this._$loaded=!1,remove(o.depComponents,this)}if(t)e.onLoad=createWraper(e.onLoad,P,null),e.onUnload=createWraper(e.onUnload,null,k);else{e.lifetimes=e.lifetimes||{};var A=function(t){return e[t]||e.lifetimes[t]},j=function(t,n){return e[t]=e.lifetimes[t]=n};j("attached",createWraper(A("attached"),P,null)),j("detached",createWraper(A("detached"),null,k))}}}]),e}(),version="0.2.4",nativePage=Page,nativeComponent=Component;function expandConfig(e,t,n){isEmptyObject(t)||(n?mixinMethods(e,t):(e.methods=e.methods||{},mixinMethods(e.methods,t)))}function index(e,t,n){var a=new Store(t,n),o=mixin(e);return Page=createWraper(nativePage,(function(e){callHook(t,"createBefore",[e,!0]),expandConfig(e,o,!0),a.rewirteConfigAndAddDep(e,!0)})),Component=createWraper(nativeComponent,(function(e){callHook(t,"createBefore",[e,!1]),expandConfig(e,o,!1),a.rewirteConfigAndAddDep(e,!1)})),a}exports.clone=clone,exports.createModule=createModule,exports.default=index,exports.diff=diff,exports.isModule=isModule,exports.restore=restore,exports.version=version;
