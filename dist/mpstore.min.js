"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],a=!0,r=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(n.push(o.value),!t||n.length!==t);a=!0);}catch(e){r=!0,i=e}finally{try{a||null==s.return||s.return()}finally{if(r)throw i}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warning(e,t){if(e="\n\n[MpStore warning]: ".concat(e,"\n\n"),!t)throw new Error(e);console.warn(e)}function assert(e,t){e||warning(t)}function isPrimitive(e){return"string"==typeof e||"number"==typeof e||"symbol"===_typeof(e)||"boolean"==typeof e}function deepFreeze(e){for(var t=Object.getOwnPropertyNames(e),n=t.length;~n--;){var a=e[t[n]];"object"===_typeof(a)&&null!==a&&deepFreeze(a)}return Object.freeze(e)}function mergeState(e,t){return deepFreeze(Object.assign({},e,t))}function mixinMethods(e,t){for(var n in t)n in e||(e[n]=t[n])}function remove(e,t){var n=e.findIndex((function(e){return e.component===t}));n>-1&&e.splice(n,1)}function callHook(e,t,n){if(e&&"function"==typeof e[t])return e[t].apply(e,n)}function isEmptyObject(e){for(var t in e)return!1;return!0}function mapObject(e,t){var n={};for(var a in e)e.hasOwnProperty(a)&&(n[a]=t(e[a]));return n}function createWraper(e,t,n){return function(){for(var a,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return"function"==typeof t&&t.apply(this,i),"function"==typeof e&&(a=e.apply(this,i)),"function"==typeof n&&n.apply(this,i),a}}function isPlainObject(e){if("object"!==_typeof(e)||null===e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;for(var n=t;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return t===n}function clone(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(null==e||isPrimitive(e)||"function"==typeof e||e instanceof Date)return e;if(t.has(e))return t.get(e);var n="function"!=typeof e.constructor?Object.create(null):new e.constructor;for(var a in t.set(e,n),e)n[a]=clone(e[a],t);return n}function parsePath(e){var t=e.split(".");return function(e){for(var n=0,a=t.length;n<a;n++){if(!e)return;e=e[t[n]]}return e}}function mixin(e){var t=Object.create(null);if("function"==typeof e){e((function(e,n){assert("string"==typeof e,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(e in t),'The "'.concat(e,'" is exist,')),t[e]=n}))}return t}Object.defineProperty(exports,"__esModule",{value:!0});var MODULE_FLAG="__mpModule";function isModule(e){return isPlainObject(e)&&!0===e[MODULE_FLAG]}function getModule(e,t){return t?parsePath(t)(e):e}function mergeModule(e,t,n,a){for(var r=Object.keys(t),i=r.length;~--i;){var o=r[i];"function"==typeof a?assert(!(o in e),a(o,n)):assert(!(isModule(e[o])&&!isModule(t[o])),"The [".concat(o,"] is a module that you can change to other values."))}return createModule(Object.assign({},e,t))}function createModule(e){return assert(isPlainObject(e),"The base module object must be an plain object"),isModule(e)?e:(assert(!(MODULE_FLAG in e),"the [".concat(MODULE_FLAG,"] is the keyword of the mpStore module, you can't use it")),Object.defineProperty(e,MODULE_FLAG,{value:!0,writable:!1,enumerable:!1,configurable:!1}),e)}function createModuleByNamespace(e,t,n,a,r){if(!e)return mergeModule(n,t);for(var i={},o=n,s=i,c=e.split("."),u=a?"\n\n  --- from [".concat(a,"] action"):"",l=0,f=c.length;l<f;l++){var h=c[l],d=l===f-1;if(l>0&&assert(isModule(o),"the child modules must be in the parent module.\n\n"+"  the parent module namespace is [".concat(c[l-1],"]\n\n")+"  the child module namespace is [".concat(h,"]").concat(u)),h in o){assert(isModule(o[h]),"you can't create child moudle, "+"because the [".concat(h,"] already exists in [").concat(c[l-1]||"root","] module, ")+"but [".concat(h,"] not a module.").concat(u));var p=d?mergeModule(o[h],t,h,r):createModule(Object.assign({},o[h]));i[h]=p,i=p,o=p}else{var y=createModule(d?t:{});i[h]=y,i=y,o=y}}return s}var ADD=1,REMOVE=2,REPLACE=3;function Patch(e,t,n,a){this.type=e,this.path=t,this.value=n,this.leftValue=a}function diffValues(e,t,n,a){"function"==typeof e||null===e?a.push(new Patch(REPLACE,n,t,e)):Array.isArray(e)?Array.isArray(t)?walkArray(e,t,n,a):a.push(new Patch(REPLACE,n,t,e)):"object"===_typeof(e)?null===t||"object"!==_typeof(t)||Array.isArray(t)?a.push(new Patch(REPLACE,n,t,e)):e instanceof Date||t instanceof Date?a.push(new Patch(REPLACE,n,t,e)):walkObject(e,t,n,a):a.push(new Patch(REPLACE,n,t,e))}function walkArray(e,t,n,a){if(e.length<=t.length){for(var r=e.length;~--r;)if(e[r]!==t[r]){var i="".concat(n,"[").concat(r,"]");diffValues(e[r],t[r],i,a)}if(t.length>e.length)for(r=t.length;--r>=e.length;){var o="".concat(n,"[").concat(r,"]");a.push(new Patch(ADD,o,t[r],e[r]))}}else a.push(new Patch(REPLACE,n,t,e))}function walkObject(e,t,n,a){for(var r in e){var i="".concat(n,".").concat(r);r in t?e[r]!==t[r]&&diffValues(e[r],t[r],i,a):a.push(new Patch(REMOVE,i,null,e[r]))}for(var o in t)if(!(o in e)){var s="".concat(n,".").concat(o);a.push(new Patch(ADD,s,t[o],null))}}function diff(e,t,n){var a=[];return walkObject(e,t,n,a),a}var REG=/[^\[\].]+(?=[\[\].])/g;function separatePath(e,t){var n=t.match(REG);if(n&&n.shift()&&n.length>0){for(var a=-1,r=null,i=e,o=null;a++<n.length-2;)o=i,i=i[r=n[a]];return[i,r,o,n[n.length-1]]}}function restore(e,t){for(var n=t.length,a=new Map;~--n;){var r=t[n],i=r.type,o=r.path,s=r.leftValue,c=separatePath(e,o+".");if(c){var u=_slicedToArray(c,4),l=u[0],f=u[1],h=u[2],d=u[3];switch(i){case REMOVE:case REPLACE:l[d]=s;break;case ADD:Array.isArray(l)&&l===h[f]&&a.set(l,{key:f,prevTarget:h}),delete l[d]}}}return a.forEach((function(e,t){var n=e.key,a=e.prevTarget,r=new t.constructor;t.forEach((function(e){return r.push(e)})),a[n]=r})),e}function applyPatchs(e,t,n){for(var a={},r=0,i=t.length;r<i;r++){var o=t[r],s=o.value;a[o.path]=s}e.setData(a,n)}function updateComponents(e,t){var n=0,a=e.hooks,r=e.GLOBALWORD,i=e.depComponents,o=i.length;if(0!==o)for(var s=function(){++n===o&&"function"==typeof t&&t()},c=0;c<o;c++){var u=i[c],l=u.isPage,f=u.component,h=u.didUpdate,d=u.willUpdate,p=u.createState;if(f.data[r]){var y=p();if("function"==typeof d&&!1===d.call(e,f,y)){s();continue}var m=diff(f.data[r],y,r);if(m.length>0){if(!1===callHook(a,"willUpdate",[f,y,m,l])){s();continue}applyPatchs(f,m,s),"function"==typeof h&&h.call(e,f,y,m),callHook(a,"didUpdate",[f,y,l]),f.timeTravel&&f.timeTravel.push(m)}else s()}else s()}else"function"==typeof t&&t()}var TimeTravel=function(){function e(t,n,a){_classCallCheck(this,e),this.history=[],this.limit=a,this.component=t,this.GLOBALWORD=n,this.length=this.history.length,this.current=this.history.length,this.finallyState=t.data[n]}return _createClass(e,[{key:"push",value:function(e){var t=this.limit,n=this.history,a=this.GLOBALWORD,r=this.history.length,i=this.component.data;if(t>0){var o=r-t;o>=0&&this.history.splice(0,o+1),this.history.push(e),this.length=n.length,this.current=n.length,this.finallyState=clone(i[a])}}},{key:"go",value:function(e){var t=this.current,n=this.history,a=this.component,r=this.GLOBALWORD,i=this.finallyState;if(assert(r in a.data,"You can't use [timeTravel] because it only works for [global state]"),this.limit>0&&0!==e){var o=e+t,s=Math.abs(e);if(o<0||o>n.length)return void warning("Index [".concat(o,"] is not within the allowed range."),!0);for(var c=0,u=clone(a.data[r]);c++<s;){var l=t+Math.sign(e)*c;if(l<n.length)u=restore(u,clone(n[l]));else u=i}var f=diff(a.data[r],u,r);f.length>0&&applyPatchs(a,f),this.current+=e}}},{key:"forward",value:function(){this.go(1)}},{key:"back",value:function(){this.go(-1)}},{key:"toStart",value:function(){this.go(-this.current)}},{key:"toEnd",value:function(){this.go(this.history.length-this.current)}}]),e}(),COMMONACTION=function(){};function match(e,t){return e.action===COMMONACTION||t===e.action}function handleLayer(e,t,n,a,r,i){try{t.call(n,a,r,e),i()}catch(t){var o=n.hooks;i(),o&&"function"==typeof o.middlewareError?o.middlewareError(e,a,t):warning("".concat(t,"\n\n   --- from middleware [").concat(e,"] action."))}}var Middleware=function(){function e(t){_classCallCheck(this,e),this.stack=[],this.store=t,this.isProcessing=!1}return _createClass(e,[{key:"use",value:function(e,t){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:t,action:e})}},{key:"remove",value:function(e,t){var n=this.stack.findIndex((function(n){return n.fn===t&&n.action===e}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(e,t,n){var a=this;this.isProcessing=!0;var r=function(){a.isProcessing=!1};if(this.stack.length>0){var i=0;!function t(o){var s=a.stack[i];for(i++;s&&!match(s,e);)s=a.stack[i++];s?handleLayer(e,s.fn,a.store,o,t,r):n(o,r)}(t)}else n(t,r)}}]),e}(),storeId=0;function assertReducer(e,t){var n=t.setter,a=t.partialState;return assert("partialState"in t,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(a),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),"function"!=typeof n&&(t.setter=function(){warning("Can't changed [".concat(e,"] action value. Have you defined a setter?")+"\n\n --- from [".concat(e,"] action."))}),t}function filterReducer(e,t,n){var a=n.namespace,r=n.partialState;if("namespace"in n)assert("string"==typeof a,"The module namespace must be a string."+"\n\n --- from [".concat(t,"] action.")),isEmptyObject(r)||(n.partialState=createModuleByNamespace(a,r,e,t,(function(e,n){return"The [".concat(e,"] already exists in [").concat(n,"] module, ")+"Please don't repeat defined. \n\n --- from [".concat(t,"] action.")})));else for(var i in r)assert(!e.hasOwnProperty(i),"The [".concat(i,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(t,"] action."));return n}var Store=function(){function e(t){_classCallCheck(this,e),this.hooks=t,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.10",this.state=Object.freeze(createModule({})),this.middleware=new Middleware(this)}return _createClass(e,[{key:"add",value:function(e,t){assert(!this.reducers.find((function(t){return t.action===e})),"Can't repeat defined [".concat(e,"] action.")),assertReducer(e,t),filterReducer(this.state,e,t),t.action=e,this.reducers.push(t);var n=t.partialState;isEmptyObject(n)||(this.state=mergeState(this.state,n))}},{key:"dispatch",value:function(e,t,n){var a=this,r=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(e,"] action."));var i=r.find((function(t){return t.action===e}));assert(i,"The [".concat(e,"] action does not exist. ")+"Maybe you have not defined."),this.middleware.process(e,t,(function(t,r){a.isDispatching=!0;try{var o,s=i.namespace,c="string"==typeof s;if(c){var u=a.getModule(s,"\n\n --- from [".concat(e,"] action."));o=i.setter(u,t,a.state)}else o=i.setter(a.state,t);assert(isPlainObject(o),"setter function should be return a plain object."),isEmptyObject(o)||(c&&(o=createModuleByNamespace(s,o,a.state,e)),a.state=mergeState(a.state,o))}finally{a.isDispatching=!1,r()}updateComponents(a,n)}))}},{key:"use",value:function(e,t){var n=this;return"function"==typeof e&&e!==COMMONACTION&&(t=e,e=COMMONACTION),this.middleware.use(e,t),function(){return n.middleware.remove(e,t)}}},{key:"setNamespace",value:function(e){assert(e&&"string"==typeof e,"The [namespace] must be a string"),this.GLOBALWORD=e}},{key:"getModule",value:function(e,t){if(assert("string"==typeof e,"the namespace mast be a string"),!e)return this.state;var n=getModule(this.state,e);return t&&!isModule(n)&&warning("The [".concat(e,"] module is not exist.").concat(t||"")),n}},{key:"addModule",value:function(e,t){if(assert("string"==typeof e,"the namespace mast be a string"),isPlainObject(t))for(var n in t){t[n].namespace=e,this.add(n,t)}}},{key:"rewirteConfigAndAddDep",value:function(e,t){var n=this,a=null,r=this,i=this.GLOBALWORD,o=e.data,s=e.storeConfig,c=void 0===s?{}:s,u=c.useState,l=c.didUpdate,f=c.willUpdate,h=c.defineReducer,d=c.travelLimit,p=void 0===d?0:d;if(assert("number"==typeof p,"[travelLimit] must be a number, but now is [".concat(_typeof(p),"].")),delete e.storeConfig,"function"==typeof h&&h.call(r,r),"function"==typeof u){var y=null,m=null,v=u.call(r,r);Array.isArray(v)?(y=v[0],m=v[1]):m=v,assert(isPlainObject(m),"[useState] must return a plain object, "+"but now is return a [".concat(_typeof(m),"]")),a=function(){return clone(mapObject(m,(function(e){return null===y?e(r.state):e(n.getModule(y,"\n\n   --- from [".concat(y,"] of useState.")),r.state)})))}}if(null!==a){var g=a();isPlainObject(g)&&(o?o[i]=g:e.data=_defineProperty({},i,g))}var b=function(e){if(!1!==callHook(n.hooks,"addDep",[e,t])&&null!==a&&e.data&&isPlainObject(e.data[i])){e.timeTravel=new TimeTravel(e,i,p),n.depComponents.push({isPage:t,component:e,didUpdate:l,willUpdate:f,createState:a});var r=diff(e.data[i],a(),i);r.length>0&&applyPatchs(e,r,i)}};if(t)e.onLoad=createWraper(e.onLoad,(function(){b(this),this.store=r})),e.onUnload=createWraper(e.onUnload,null,(function(){remove(r.depComponents,this)}));else{e.lifetimes=e.lifetimes||{};var O=function(t){return e[t]||e.lifetimes[t]},w=function(t,n){return e[t]=e.lifetimes[t]=n};w("attached",createWraper(O("attached"),(function(){b(this),this.store=r}))),w("detached",createWraper(O("detached"),null,(function(){remove(r.depComponents,this)})))}}}]),e}(),version="0.0.10",nativePage=Page,nativeComponent=Component;function expandConfig(e,t,n){isEmptyObject(t)||(n?mixinMethods(e,t):(e.methods=e.methods||{},mixinMethods(e.methods,t)))}function index(e,t){var n=new Store(t),a=mixin(e);return Page=createWraper(nativePage,(function(e){callHook(t,"createBefore",[e,!0]),expandConfig(e,a,!0),n.rewirteConfigAndAddDep(e,!0)})),Component=createWraper(nativeComponent,(function(e){callHook(t,"createBefore",[e,!1]),expandConfig(e,a,!1),n.rewirteConfigAndAddDep(e,!1)})),n}exports.clone=clone,exports.createModule=createModule,exports.default=index,exports.diff=diff,exports.restore=restore,exports.version=version;
