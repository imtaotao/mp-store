"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){a=!0,i=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw i}}return n}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function warning(t,e){if(t="\n\n[MpStore warning]: ".concat(t,"\n\n"),!e)throw new Error(t);console.warn(t)}function assert(t,e){t||warning(e)}function isPrimitive(t){return"string"==typeof t||"number"==typeof t||"symbol"===_typeof(t)||"boolean"==typeof t}function deepFreeze(t){for(var e=Object.getOwnPropertyNames(t),n=e.length;~n--;){var r=t[e[n]];"object"===_typeof(r)&&null!==r&&deepFreeze(r)}return Object.freeze(t)}function mergeState(t,e){return deepFreeze(Object.assign({},t,e))}function mixinMethods(t,e){for(var n in e)n in t||(t[n]=e[n])}function remove(t,e){var n=t.findIndex((function(t){return t.component===e}));n>-1&&t.splice(n,1)}function callHook(t,e,n){if(t&&"function"==typeof t[e])return t[e].apply(t,n)}function isEmptyObject(t){for(var e in t)return!1;return!0}function mapObject(t,e){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]=e(t[r]));return n}function createWraper(t,e,n){return function(){for(var r,a=arguments.length,i=new Array(a),o=0;o<a;o++)i[o]=arguments[o];return"function"==typeof e&&e.apply(this,i),"function"==typeof t&&(r=t.apply(this,i)),"function"==typeof n&&n.apply(this,i),r}}function isPlainObject(t){if("object"!==_typeof(t)||null===t)return!1;var e=Object.getPrototypeOf(t);if(null===e)return!0;for(var n=e;null!==Object.getPrototypeOf(n);)n=Object.getPrototypeOf(n);return e===n}function clone(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(null==t||isPrimitive(t)||"function"==typeof t||t instanceof Date)return t;if(e.has(t))return e.get(t);var n="function"!=typeof t.constructor?Object.create(null):new t.constructor;for(var r in e.set(t,n),t)n[r]=clone(t[r],e);return n}function mixin(t){var e=Object.create(null);if("function"==typeof t){t((function(t,n){assert("string"==typeof t,"The mixed method name must a string."),assert("function"==typeof n,"The mixed method is not a function."),assert(!(t in e),'The "'.concat(t,'" is exist,')),e[t]=n}))}return e}Object.defineProperty(exports,"__esModule",{value:!0});var ADD=1,REMOVE=2,REPLACE=3;function Patch(t,e,n,r){this.type=t,this.path=e,this.value=n,this.leftValue=r}function diffValues(t,e,n,r){"function"==typeof t||null===t?r.push(new Patch(REPLACE,n,e,t)):Array.isArray(t)?Array.isArray(e)?walkArray(t,e,n,r):r.push(new Patch(REPLACE,n,e,t)):"object"===_typeof(t)?null===e||"object"!==_typeof(e)||Array.isArray(e)?r.push(new Patch(REPLACE,n,e,t)):t instanceof Date||e instanceof Date?r.push(new Patch(REPLACE,n,e,t)):walkObject(t,e,n,r):r.push(new Patch(REPLACE,n,e,t))}function walkArray(t,e,n,r){if(t.length<=e.length){for(var a=t.length;~--a;)if(t[a]!==e[a]){var i="".concat(n,"[").concat(a,"]");diffValues(t[a],e[a],i,r)}if(e.length>t.length)for(a=e.length;--a>=t.length;){var o="".concat(n,"[").concat(a,"]");r.push(new Patch(ADD,o,e[a],t[a]))}}else r.push(new Patch(REPLACE,n,e,t))}function walkObject(t,e,n,r){for(var a in t){var i="".concat(n,".").concat(a);a in e?t[a]!==e[a]&&diffValues(t[a],e[a],i,r):r.push(new Patch(REMOVE,i,null,t[a]))}for(var o in e)if(!(o in t)){var s="".concat(n,".").concat(o);r.push(new Patch(ADD,s,e[o],null))}}function diff(t,e,n){var r=[];return walkObject(t,e,n,r),r}var REG=/[^\[\].]+(?=[\[\].])/g;function separatePath(t,e){var n=e.match(REG);if(n&&n.shift()&&n.length>0){for(var r=-1,a=null,i=t,o=null;r++<n.length-2;)o=i,i=i[a=n[r]];return[i,a,o,n[n.length-1]]}}function restore(t,e){for(var n=e.length,r=new Map;~--n;){var a=e[n],i=a.type,o=a.path,s=a.leftValue,c=separatePath(t,o+".");if(c){var l=_slicedToArray(c,4),f=l[0],u=l[1],h=l[2],p=l[3];switch(i){case REMOVE:case REPLACE:f[p]=s;break;case ADD:Array.isArray(f)&&f===h[u]&&r.set(f,{key:u,prevTarget:h}),delete f[p]}}}return r.forEach((function(t,e){var n=t.key,r=t.prevTarget,a=new e.constructor;e.forEach((function(t){return a.push(t)})),r[n]=a})),t}function applyPatchs(t,e,n){for(var r={},a=0,i=e.length;a<i;a++){var o=e[a],s=o.value;r[o.path]=s}t.setData(r,n)}function updateComponents(t,e){var n=0,r=t.hooks,a=t.GLOBALWORD,i=t.depComponents,o=i.length;if(0!==o)for(var s=function(){++n===o&&"function"==typeof e&&e()},c=0;c<o;c++){var l=i[c],f=l.isPage,u=l.component,h=l.didUpdate,p=l.willUpdate,d=l.createState;if(u.data[a]){var y=d();if("function"==typeof p&&!1===p.call(t,u,y)){s();continue}var v=diff(u.data[a],y,a);if(v.length>0){if(!1===callHook(r,"willUpdate",[u,y,v,f])){s();continue}applyPatchs(u,v,s),"function"==typeof h&&h.call(t,u,y,v),callHook(r,"didUpdate",[u,y,f]),u.timeTravel&&u.timeTravel.push(v)}else s()}else s()}else"function"==typeof e&&e()}var TimeTravel=function(){function t(e,n,r){_classCallCheck(this,t),this.history=[],this.limit=r,this.component=e,this.GLOBALWORD=n,this.length=this.history.length,this.current=this.history.length,this.finallyState=e.data[n]}return _createClass(t,[{key:"push",value:function(t){var e=this.limit,n=this.history,r=this.GLOBALWORD,a=this.history.length,i=this.component.data;if(e>0){var o=a-e;o>=0&&this.history.splice(0,o+1),this.history.push(t),this.length=n.length,this.current=n.length,this.finallyState=clone(i[r])}}},{key:"go",value:function(t){var e=this.current,n=this.history,r=this.component,a=this.GLOBALWORD,i=this.finallyState;if(assert(a in r.data,"You can't use [timeTravel] because it only works for [global state]"),this.limit>0&&0!==t){var o=t+e,s=Math.abs(t);if(o<0||o>n.length)return void warning("Index [".concat(o,"] is not within the allowed range."),!0);for(var c=0,l=clone(r.data[a]);c++<s;){var f=e+Math.sign(t)*c;if(f<n.length)l=restore(l,clone(n[f]));else l=i}var u=diff(r.data[a],l,a);u.length>0&&applyPatchs(r,u),this.current+=t}}},{key:"forward",value:function(){this.go(1)}},{key:"back",value:function(){this.go(-1)}},{key:"toStart",value:function(){this.go(-this.current)}},{key:"toEnd",value:function(){this.go(this.history.length-this.current)}}]),t}(),COMMONACTION=function(){};function match(t,e){return t.action===COMMONACTION||e===t.action}function handleLayer(t,e,n,r,a,i){try{e.call(n,r,a,t),i()}catch(e){var o=n.hooks;i(),o&&"function"==typeof o.middlewareError?o.middlewareError(t,r,e):warning("".concat(e,"\n\n   --- from middleware [").concat(t,"] action."))}}var Middleware=function(){function t(e){_classCallCheck(this,t),this.stack=[],this.store=e,this.isProcessing=!1}return _createClass(t,[{key:"use",value:function(t,e){assert(!this.isProcessing,"can't allow add new middleware in the middleware processing."),this.stack.push({fn:e,action:t})}},{key:"remove",value:function(t,e){var n=this.stack.findIndex((function(n){return n.fn===e&&n.action===t}));n>-1&&this.stack.splice(n,1)}},{key:"process",value:function(t,e,n){var r=this;this.isProcessing=!0;var a=function(){r.isProcessing=!1};if(this.stack.length>0){var i=0;!function e(o){var s=r.stack[i];for(i++;s&&!match(s,t);)s=r.stack[i++];s?handleLayer(t,s.fn,r.store,o,e,a):n(o,a)}(e)}else n(e,a)}}]),t}(),storeId=0;function assertReducer(t,e,n){var r=n.setter,a=n.partialState;for(var i in assert("partialState"in n,"You must defined [partialState]."+"\n\n --- from [".concat(e,"] action.")),assert(isPlainObject(a),"The [partialState] must be an object."+"\n\n --- from [".concat(e,"] action.")),a)assert(!t.hasOwnProperty(i),"The [".concat(i,"] already exists in global state, ")+"Please don't repeat defined. \n\n --- from [".concat(e,"] action."));return"function"!=typeof r&&(n.setter=function(){throw"Can't changed [".concat(e,"] action value. Have you defined a setter?")}),n}var Store=function(){function t(e){_classCallCheck(this,t),this.hooks=e,this.reducers=[],this.id=++storeId,this.depComponents=[],this.GLOBALWORD="global",this.isDispatching=!1,this.version="0.0.10",this.state=Object.freeze({}),this.middleware=new Middleware(this)}return _createClass(t,[{key:"add",value:function(t,e){assert(!this.reducers.find((function(e){return e.action===t})),"Can't repeat defined [".concat(t,"] action."));var n=assertReducer(this.state,t,e).partialState;e.action=t,this.reducers.push(e),isEmptyObject(n)||(this.state=mergeState(this.state,n))}},{key:"dispatch",value:function(t,e,n){var r=this,a=this.reducers;assert(!this.isDispatching,'It is not allowed to call "dispatch" during dispatch execution.'+"\n\n   --- from [".concat(t,"] action."));var i=a.find((function(e){return e.action===t}));assert(i,"The [".concat(t,"] action does not exist. ")+"Maybe you have not defined."),this.middleware.process(t,e,(function(t,e){r.isDispatching=!0;try{var a=i.setter(r.state,t);assert(isPlainObject(a),"setter function should be return a plain object."),isEmptyObject(a)||(r.state=mergeState(r.state,a))}finally{r.isDispatching=!1,e()}updateComponents(r,n)}))}},{key:"use",value:function(t,e){var n=this;return"function"==typeof t&&t!==COMMONACTION&&(e=t,t=COMMONACTION),this.middleware.use(t,e),function(){return n.middleware.remove(t,e)}}},{key:"setNamespace",value:function(t){assert(t&&"string"==typeof t,"The [namespace] must be a string"),this.GLOBALWORD=t}},{key:"rewirteCfgAndAddDep",value:function(t,e){var n=this,r=null,a=this,i=this.GLOBALWORD,o=t.data,s=t.storeConfig,c=void 0===s?{}:s,l=c.useState,f=c.didUpdate,u=c.willUpdate,h=c.defineReducer,p=c.travelLimit,d=void 0===p?0:p;if(assert("number"==typeof d,"[travelLimit] must be a number, but now is [".concat(_typeof(d),"].")),delete t.storeConfig,"function"==typeof h&&h.call(a,a),"function"==typeof l){var y=l.call(a,a);assert(isPlainObject(y),"[useState] must return a plain object, "+"but now is return a [".concat(_typeof(y),"]")),r=function(){return clone(mapObject(y,(function(t){return t(a.state)})))}}if(null!==r){var v=r();isPlainObject(v)&&(o?o[i]=v:t.data=_defineProperty({},i,v))}var m=function(t){if(!1!==callHook(n.hooks,"addDep",[t,e])&&null!==r&&t.data&&isPlainObject(t.data[i])){t.timeTravel=new TimeTravel(t,i,d),n.depComponents.push({isPage:e,component:t,didUpdate:f,willUpdate:u,createState:r});var a=diff(t.data[i],r(),i);a.length>0&&applyPatchs(t,a,i)}};if(e)t.onLoad=createWraper(t.onLoad,(function(){m(this),this.store=a})),t.onUnload=createWraper(t.onUnload,null,(function(){remove(a.depComponents,this)}));else{t.lifetimes=t.lifetimes||{};var g=function(e){return t[e]||t.lifetimes[e]},b=function(e,n){return t[e]=t.lifetimes[e]=n};b("attached",createWraper(g("attached"),(function(){m(this),this.store=a}))),b("detached",createWraper(g("detached"),null,(function(){remove(a.depComponents,this)})))}}}]),t}(),version="0.0.10",nativePage=Page,nativeComponent=Component;function expandConfig(t,e,n){isEmptyObject(e)||(n?mixinMethods(t,e):(t.methods=t.methods||{},mixinMethods(t.methods,e)))}function index(t,e){var n=new Store(e),r=mixin(t);return Page=createWraper(nativePage,(function(t){callHook(e,"createBefore",[t,!0]),expandConfig(t,r,!0),n.rewirteCfgAndAddDep(t,!0)})),Component=createWraper(nativeComponent,(function(t){callHook(e,"createBefore",[t,!1]),expandConfig(t,r,!1),n.rewirteCfgAndAddDep(t,!1)})),n}exports.clone=clone,exports.default=index,exports.diff=diff,exports.restore=restore,exports.version=version;
